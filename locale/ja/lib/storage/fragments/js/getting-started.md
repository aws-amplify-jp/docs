> 前提条件: [](~/cli/start/install.md) Amplify CLI をインストールして構成する

## Amplify付きストレージ

AWS Amplify Storage モジュールは、アプリケーションのユーザーコンテンツをパブリック、保護、またはプライベートのストレージバケットで管理するための簡単なメカニズムを提供します。 ストレージカテゴリには、Amazon S3のサポートが組み込まれています。

There are two ways to add storage with Amplify - manual and automated. Both methods require the `auth` category with Amazon Cognito to also be enabled. If you are creating an S3 bucket from scratch, you should use the **Automated Setup**. However if you are reusing existing Cognito and S3 resources, you should opt for **Manual Setup**.

## 自動設定：ストレージバケットを作成

一から始めるには、プロジェクトのルートから次のコマンドを実行します。

```bash
増幅してストレージを追加
```

そして、プロンプトオプションで *コンテンツ* を選択します。

```console
?以下のサービスのいずれかから選択してください（矢印キーを使用）
<unk> Content (画像、音声、動画など)
  NoSQLデータベース
```

CLIは、以前に有効にしていない場合はAuthを有効にし、S3バケットに名前を付けます。バックエンドの実行を更新するには、次のようにします。

```bash
push を増幅する
```

バックエンドが正常に更新されると、新しい設定ファイル `aws-exports.js` がソースディレクトリの下にコピーされます。例: '/src'

### アプリケーションの設定

Amplifyを `yarn` または `npm` でアプリに追加します。

```bash
npm install -S aws-amplify
```

In your app’s entry point i.e. `App.js`, import and load the configuration file `aws-exports.js` which has been created and replaced into `/src` folder in the previous step.
```javascript
import Amplify, { Storage } from 'aws-amply';
import awsconfig from './aws-exports';
Amplify.configure(awsconfig);
```

## 手動設定: ストレージバケットをインポート

To configure Storage manually, you will have to configure Amplify Auth category as well. In other words, you will not be importing the autogenerated `aws-exports.js` - instead, you will be adding your own existing Amazon Cognito and Amazon S3 credentials in your app like this:

```javascript
import Amplify, { Auth, Storage } from 'aws-amplify';

Amplify.configure({
    Auth: {
        identityPoolId: 'XX-XXXX-X:XXXXXXXX-XXXX-1234-abcd-1234567890ab', //REQUIRED - Amazon Cognito Identity Pool ID
        region: 'XX-XXXX-X', // REQUIRED - Amazon Cognito Region
        userPoolId: 'XX-XXXX-X_abcd1234', //OPTIONAL - Amazon Cognito User Pool ID
        userPoolWebClientId: 'XX-XXXX-X_abcd1234', //OPTIONAL - Amazon Cognito Web Client ID
    },
    Storage: {
        AWSS3: {
            bucket: '', //REQUIRED -  Amazon S3 bucket name
            region: 'XX-XXXX-X', //OPTIONAL -  Amazon service region
        }
    }
});

```

### Amazon S3 の使用
Cognitoリソースを手動で設定する場合は、S3バケットにアクセスする権限をロールに付与する必要があります。

There are two roles created by Cognito: an `Auth_Role` that grants signed-in-user-level bucket access and an `Unauth_Role` that allows unauthenticated access to resources. Attach the corresponding policies to each role for proper S3 access. Replace `{enter bucket name}` with the correct S3 bucket.

`Auth_Role` のインラインポリシー :

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Action": [
                "s3:GetObject",
                "s3:PutObject",
                "s3:DeleteObject"
            ],
            "Resource": [
                "arn:aws:s3:::{enter bucket name}/public/*",
                "arn:aws:s3:::{enter bucket name}/protected/${cognito-identity.amazonaws.com:sub}/*",
                "arn:aws:s3:::{enter bucket name}/private/${cognito-identity.amazonaws.com:sub}/*"
            ],
            "Effect": "Allow"
        },
        {
            "Action": [
                "s3:PutObject"
            ],
            "Resource": [
                "arn:aws:s3:::{enter bucket name}/uploads/*"
            ],
            "Effect": "Allow"
        },
        {
            "Action": [
                "s3:GetObject"
            ],
            "Resource": [
                "arn:aws:s3:::{enter bucket name}/protected/*"
            ],
            "Effect": "Allow"
        },
        {
            "Condition": {
                "StringLike": {
                    "s3:prefix": [
                        "public/",
                        "public/*",
                        "protected/",
                        "protected/*",
                        "private/${cognito-identity.amazonaws.com:sub}/",
                        "private/${cognito-identity.amazonaws.com:sub}/*"
                    ]
                }
            },
            "Action": [
                "s3:ListBucket"
            ],
            "Resource": [
                "arn:aws:s3:::{enter bucket name}"
            ],
            "Effect": "Allow"
        }
    ]
}
```

`Unauth_Role` のインラインポリシー :

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Action": [
                "s3:GetObject",
                "s3:PutObject",
                "s3:DeleteObject"
            ],
            "Resource": [
                "arn:aws:s3:::{enter bucket name}/public/*"
            ],
            "Effect": "Allow"
        },
        {
            "Action": [
                "s3:PutObject"
            ],
            "Resource": [
                "arn:aws:s3:::{enter bucket name}/uploads/*"
            ],
            "Effect": "Allow"
        },
        {
            "Action": [
                "s3:GetObject"
            ],
            "Resource": [
                "arn:aws:s3:::{enter bucket name}/protected/*"
            ],
            "Effect": "Allow"
        },
        {
            "Condition": {
                "StringLike": {
                    "s3:prefix": [
                        "public/",
                        "public/*",
                        "protected/",
                        "protected/*"
                    ]
                }
            },
            "Action": [
                "s3:ListBucket"
            ],
            "Resource": [
                "arn:aws:s3:::{enter bucket name}"
            ],
            "Effect": "Allow"
        }
    ]
}
```

Amplify CLI が使用するポリシーテンプレートは [こちら](https://github.com/aws-amplify/amplify-cli/blob/b12d20b9d85f7fc6abf7e2f7fbe11e1a108911b9/packages/amplify-category-storage/provider-utils/awscloudformation/cloudformation-templates/s3-cloudformation-template.json) です。

### Amazon S3 バケットCORS ポリシーセットアップ

<amplify-callout warning>

アプリからS3バケットを呼び出すには、S3バケットのCORSポリシーを設定する必要があります。 このコールアウトはS3バケットの手動設定にのみ使用されます。 CORS ポリシーの設定は、 `amplify add storage` を実行するときに Amplify CLI を介して自動的に行われます。

</amplify-callout>

以下の手順で CORS ポリシーが設定されます。

1. [Amazon S3 Console](https://s3.console.aws.amazon.com/s3/home?region=us-east-1) に移動し、プロジェクトの `ユーザーファイル` バケットをクリックします。バケットは通常は[Project Name]-userfiles-mobilehub-format@@4-App Id]と名付けられます。
2. バケットの **パーミッション** タブをクリックし、 **CORS 構成** タイルをクリックします。
3. Bucket の CORS ポリシーを以下のように更新します。

```xml
<?xml version="1.0" encoding="UTF-8"?>
<CORSConfiguration xmlns="http://s3.amazonaws.com/doc/2006-03-01/">
<CORSRule>
    <AllowedOrigin>*</AllowedOrigin>
    <AllowedMethod>HEAD</AllowedMethod>
    <AllowedMethod>GET</AllowedMethod>
    <AllowedMethod>PUT</AllowedMethod>
    <AllowedMethod>POST</AllowedMethod>
    <AllowedMethod>DELETE</AllowedMethod>
    <MaxAgeSeconds>3000</MaxAgeSeconds>
    <ExposeHeader>x-amz-server-side-encryption</ExposeHeader>
    <ExposeHeader>x-amz-request-id</ExposeHeader>
    <ExposeHeader>x-amz-id-2</ExposeHeader>
    <ExposeHeader>ETag</ExposeHeader>
    <AllowedHeader>*</AllowedHeader>
</CORSRule>
</CORSConfiguration>
```

<amplify-callout>

**注意:** AllowedOrigin を更新して個々のドメインを含めることで、Bucket へのアクセスを制限することができます。

</amplify-callout>

Amazon S3 ファイルアクセスレベルについては、 [ファイルアクセスレベル](~/lib/storage/configureaccess.md) を参照してください。

## カスタムプラグインの使用

ストレージ用のカスタムプラグインを作成できます。アプリをカスタムストレージバックエンドと統合する場合に便利です。

プラグインを作成するには、 `StorageProvider` インターフェイスを実装します。

```typescript
import { Storage, StorageProvider } from 'aws-amplify';

export default class MyStorageProvider implements StorageProvider {
    // category and provider name
    static category = 'Storage';
    static providerName = 'MyStorage';

    // you need to implement these seven methods
    // configure your provider
    configure(config: object): object;

    // get object/pre-signed url from storage
    get(key: string, options?): Promise<String|Object>

    // upload storage object
    put(key: string, object, options?): Promise<Object>

    // remove object 
    remove(key: string, options?): Promise<any>

    // list objects for the path
    list(path, options?): Promise<any>

    // return 'Storage';
    getCategory(): string;

    // return the name of you provider
    getProviderName(): string;
```

プラグインを登録できるようになりました：

```javascript
// add the plugin
Storage.addPluggable(new MyStorageProvider());

// get the plugin
Storage.getPluggable(MyStorageProvider.providerName);

// remove the plugin
Storage.removePluggable(MyStorageProvider.providerName);

// send configuration into Amplify
Storage.configure({
    [MyStorageProvider.providerName]: { 
        // My Storage provider configuration 
    }
});

```

デフォルトのプロバイダー (Amazon S3) は、 `を呼び出した時に使用されます。 ut( ) <code> 別のプロバイダを指定しない限り:` `Storage.put(key, object, {provider: 'MyStorageProvider'})`.


## Amplify CLI によるモックとローカルテスト
Amplify CLI は、Amazon S3 でアプリケーションをテストするためのローカルモックサーバーの実行をサポートしています。 詳細については、 [CLI ツールチェーン ドキュメント](~/cli/usage/mock.md) を参照してください。

## APIリファレンス

Storage モジュールの完全な API ドキュメントについては、 [API リファレンス](https://aws-amplify.github.io/amplify-js/api/classes/storageclass.html) を参照してください。
