## AmplifyGraphQLクライアントの使用

APIカテゴリは、クエリ、変更、サブスクリプションを扱うためのGraphQLクライアントを提供します。

### クエリ宣言

Amplify CLI codegenは、可能なすべてのGraphQL文 (クエリ、変更、およびサブスクリプション) を自動的に生成し、JavaScriptアプリケーションでは、 `src/graphql` フォルダに保存します。

```javascript
import * as queries from './graphql/queries';
import * as mutations from './graphql/mutations';
import * as subscriptions from './graphql/subscriptions';
```

### シンプルなクエリ

GraphQL クエリの実行は簡単です。生成されたクエリをインポートし、 `API.graphql` で実行します。

```javascript
import { API } from 'aws-amplify';
import * as queries from './graphql/queries';

// Simple query
const allTodos = await API.graphql({ query: queries.listTodos });
console.log(allTodos); // result: { "data": { "listTodos": { "items": [/* ..... */] } } }

// Query using a parameter
const oneTodo = await API.graphql({ query: queries.getTodo, variables: { id: 'some id' }});
```

The TypeScript signature of API.graphql returns a `Promise | Observable`. [For now](https://github.com/aws-amplify/amplify-js/issues/6369), you need to assert the type before `await`ing:

```typescript
const allTodos = await (API.graphql({ query: queries.listTodos }) as Promise<ListTodoResult>);
```

必要に応じて、この引数オブジェクトの構築に役立つ `graphqlOperation` ヘルパー関数をインポートすることができます。

```javascript
import { API, graphqlOperation } from 'aws-amplify';

const oneTodo = await API.graphql(graphqlOperation(queries). etTodo, { id: 'some id' }));
// 
// const oneTodo = await API.graphql({ query: queries.getTodo, variables: { id: 'some id' }}));
```

### カスタム認証モード

デフォルトでは、各AppSync APIは、アプリを設定する際にデフォルトの認証モードで設定されます。 デフォルトの認証モードを上書きしたい場合は、 `authMode` プロパティを指定することで行うことができます。 例えば、API Key の認証とIAM auth を介した認証済みの読み込みを公開している場合に便利です。

#### カスタム認証モードでクエリ

```js
import { API } from 'aws-amplify';
import * as queries from './graphql/queries';

const todos = await API.graphql({
  query: queries.listTodos,
  authMode: 'AWS_IAM'
});
```

## フィルタリングおよびページ化されたクエリ

As your data grows, you will want to do pagination and filtering at the AppSync level instead of on the client. Fortunately, this is already built in to `API.graphql`, but you need to understand the schema of these queries. [This is explained in the AppSync docs](https://docs.aws.amazon.com/appsync/latest/devguide/using-your-api.html), but here we will translate them to the `API.graphql` equivalent.

入力スキーマはGraphQL エクスプローラの Docs ペイン、または 自動生成された `/graphql` フォルダ内にあります。 これらは次のようになります:

```graphql
listProducts(
  filter: ModelTodoFilterInput
  limit: Int
  nextToken: String): ModelTodoConnection

input ModelTodoFilterInput {
    id: ModelIDInput
    priority: ModelIntInput
    # ... all your other Todo fields here
    and: [ModelTodoFilterInput]
    or: [ModelTodoFilterInput]
    not: ModelTodoFilterInput
}
```

### クエリのフィルタリング

スキーマ内のこれらの入力型は、どのようなフィルタリングを実行できるかを示します。 例えば、 `ModelIntInput` のような整数フィールドには、次のスキーマがあります:

```graphql
input {
    ne: Int # "not equal to"
    eq: Int # "equal to"
    le: Intの # "less than or equal to"
    lt: Intの # "less than"
    ge: Intの # "greater than or equal to"
    gt: Intの # "greater than"
    between: [Int]
    attributeExists: Boolean attribute:
    type: ModelAttributeType
}
```

これらはフィールドの種類によって異なりますが、対応する [DynamoDB クエリ](https://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API_Condition.html) にリンクされています。

```js
// Query with filters, limits, and pagination
let filter = {
    priority: {
        eq: 1 // filter priority = 1
    }
};
await API.graphql({ query: listProducts, variables: { filter: filter}}));
```

### 複合フィルター

You can combine filters with `and`, `or`, and `not` boolean logic. Observe, in the autogenerated schema above, that `ModelTodoFilterInput` is recursive in respect to those fields. So if, for example, you wanted to filter for `priority` values of 1 OR 2, you would do this:

```js
let filter = {
      or: [{ priority: {eq:1} },
           { priority: {eq:2} }]
  };
await API.graphql({ query: listProducts, variables: { filter: filter}}));
```

1 AND 2 の `優先度` のクエリは結果を返しません。これは自然言語の代わりに boolean ロジックであるためです。

### クエリをページ化

Pagination in AppSync is done by making a request with a `limit`, and getting back a `nextToken` in order to get a cursor for the next page in your query:

```js
// page 1 of query
const { data: { listProducts: { items: itemsPage1, nextToken } } } = await API.graphql({ query: listProducts, variables: { limit: 20, /* add filter as needed */ }}));
// // we are assuming that `listProducts` includes a query for `nextToken`, which is the case for autogenerated GraphQL query strings.

// page 2 of query
const { data: { listProducts: { items: itemsPage2 } } } = await API.graphql({ query: listProducts, variables: { limit: 20, nextToken }}));
```

A `nextToken` is a very long string that looks like `"eyJ2ZXJzaW9uejE1a2RPanZPQzFCMlFTdGNxdUFBQUJxekNDQWFjR0NTcUdTSWIzRFFFSEJxQ0NBWmd3Z2dHVUFnRUFNSUlCalFZSktvWklodmNOQVFjQk1CNEdDV0NHU0FGbEF3UUJMakFSQkF5eEtWQjUvTlJxS2o5ZHBYc0NBUkNBZ2dGZUZFNW1MbTRkb25BOUg0U0FpOGhSZ1lucmRndmQz"` which represents the cursor to the starting item of the next query made with these filters.

### よく寄せられる質問

- 現時点で総ページ数を取得するAPIはありません。 すべての項目をスキャンすることは、 [潜在的に高価な操作](https://github.com/aws-amplify/amplify-js/issues/2901) であることに注意してください。
- Sorting is [available in DataStore](https://docs.amplify.aws/lib/datastore/data-access/q/platform/js#predicates) but not in AppSync.
- AppSync スキーマは [リレー仕様](https://relay.dev/docs/en/graphql-server-specification.html) のエッジ/ノードに従っていませんが、精神的に似ています。
- [は `ページ` 番号](https://github.com/aws-amplify/amplify-cli/issues/5086)でクエリできません。 `nextToken` でクエリする必要があります。

## AWS AppSync SDK の使用

以下のドキュメントでは、AWS AppSync を搭載した Apollo クライアントと API を使用して理解する方法について説明しています。 React 、VueなどのJavaScriptフレームワークで使用するサンプルコード。 または、SDK で問題を解決するには、 [AppSync Apollo クライアント SDK GitHub リポジトリ](https://github.com/awslabs/aws-mobile-appsync-sdk-js/) を参照してください。

**設定**

AWS SDKは、AWSリージョンとサービスエンドポイントを定義する `aws-exports.js` と呼ばれる集中管理されたファイルを介して構成をサポートします。 あなたはこのファイルを二つの方法のいずれかで取得します。 AppSync コンソールで AppSync API を作成するか、Amplify CLI を使用するかによって異なります。

* If you are creating your API in the console, navigate to the `Getting Started` page, and follow the steps in the `Integrate with your app` section. The `aws-exports.js` file you download is already populated for your specific API. Place the file in the `src` directory of your JavaScript project.

* If you are creating your API with the Amplify CLI (using `amplify add api`), the `aws-exports.js` file is automatically downloaded and updated each time you run `amplify push` to update your cloud resources. The file is placed in the `src` directory that you choose when setting up your JavaScript project.

**コード生成**

JavaScript で GraphQL 操作を実行するには、GraphQL 文を持つ必要があります(例えば、GraphQL 文を実行する必要があります)。 サーバーにネットワークを介して送信するクエリ、変更、またはサブスクリプション)。 必要に応じてコード生成プロセスを実行してこれを行うことができます。 Amplify CLI ツールチェーンを使用すると、スキーマを自動的に引き出し、デフォルトの GraphQL クエリ、変更、およびサブスクリプションを生成することで、これを容易にできます。 クライアントの要件が変更された場合、これらのGraphQL文を変更することができ、JavaScriptプロジェクトが自動的に取得します。 CLI を使用して TypeScript 定義を生成し、型を再生成することもできます。

**AppSync API コンソールで作成された**

Amplify CLI をインストールした後、ターミナルを開き、JavaScript プロジェクトのルートに移動し、以下を実行します。

```bash
amplify init
amplify add codegen --apiId XXXXXX
```

The `XXXXXX` is the unique AppSync API identifier that you can find in the console in the root of your API's integration page. When you run this command you can accept the defaults, which create a `./src/graphql` folder structure with your statements.

**AppSync API CLIを使用して作成されたAPI**

ターミナル内のJavaScriptプロジェクト・ディレクトリに移動し、以下を実行します。

```bash
amplify init ## プラットフォームとしてJavaScriptを選択します。
増幅add api ## GraphQL、APIキー、"Todoアプリケーションフィールドを持つ単一オブジェクト" を選択します。
```

サービス タイプのプロンプトが表示されたら、 *GraphQL* を選択します:

```console
?以下のサービスから選択してください（矢印キーを使用）
<unk> GraphQL
  REST
```

The `add api` flow above will ask you some questions, such as if you already have an annotated GraphQL schema. If this is your first time using the CLI select **No** and let it guide you through the default project **"Single object with fields (e.g., “Todo” with ID, name, description)"** as it will be used in the code examples below. Later on, you can always change it.

GraphQL エンドポイントに名前を付け、認証タイプを選択します。

```console
? Please select from one of the below mentioned services GraphQL
? Provide API name: myTodosApi
? Choose an authorization type for the API (Use arrow keys)
❯ API key
  Amazon Cognito User Pool
```

<amplify-callout> AWS AppSync API キーは作成から 7 日後に期限切れになり、API KEY 認証を使用することは開発にのみ推奨されます。 初期設定後にAWS AppSync の認証タイプを変更する。 `$ amplify update api` コマンドを使用し、 `GraphQL` を選択します。 </amplify-callout>

When you update your backend with *push* command, you can go to [AWS AppSync Console](http://console.aws.amazon.com/appsync/home) and see that a new API is added under *APIs* menu item:

```bash
push を増幅する
```

The `amplify push` process will prompt you to enter the codegen process and walk through configuration options. Accept the defaults and it will create a `./src/graphql` folder structure with your documents. You also will have an `aws-exports.js` file that the AppSync client will use for initialization. At any time you can open the AWS console for your new API directly by running the following command:

```bash
コンソールの api を増幅する
```

プロンプトが表示されたら、 **GraphQL**を選択します。 これにより、AWS AppSync コンソールが開き、クエリ、ミューテーションを実行できます。 またはサーバーでサブスクリプションを行い、クライアントアプリケーションの変更を確認します。

#### 依存関係

JavaScriptプロジェクトでAppSyncを使用するには、以下の依存関係を追加してください。

```bash
npm install aws-appsync graphql-tag
```

または、Yarn を使用している場合:

```bash
yarn add aws-appsync graphql-tag
```

#### クライアントの初期化

アプリのエントリポイントで、AWS AppSync クライアントをインポートしてインスタンス化します。

```javascript
import gql from 'graphql-tag';
import AWSAppSyncClient, { AUTH_TYPE } from 'aws-appsync';
import awsconfig from './aws-exports';

const client = new AWSAppSyncClient({
  url: awsconfig.aws_appsync_graphqlEndpoint,
  region: awsconfig.aws_appsync_region,
  auth: {
    type: AUTH_TYPE.API_KEY, // or type: awsconfig.aws_appsync_authenticationType,
    apiKey: awsconfig.aws_appsync_apiKey,
  }
});
```

#### クエリの実行

Now that the client is configured, you can run a GraphQL query. The syntax is `client.query({ query: QUERY})` which returns a `Promise` you can optionally `await` on. The `QUERY` is a GraphQL document you can write yourself or use the statements which `amplify codegen` created automatically. For example, if you have a `ListTodos` query, your code will look like the following:

```javascript
import { listTodos } from './graphql/queries';

client.query({
  query: gql(listTodos)
}).then((({ data: { listTodos } }) => {
  console.log(listTodos.items);
});
```

`fetchPolicy` を `キャッシュのみ` のようなものに変更し、ネットワーク経由でデータを取得しない場合。 キャッシュが水和されるのを待つ必要があります(Apollo のキャッシュを使用するには、ストレージからインメモリオブジェクトをインスタンス化します)。

```javascript
import { listTodos } from './graphql/queries';

(async () => { 
  await client.hydrated();

  const result = await client.query({
    query: gql(listTodos),
    fetchPolicy: 'cache-only',
  });
  console.log(result.data.listTodos.items);
})();
```

AppSync で使用するには、デフォルトの `fetchPolicy: 'cache-and-network` を残すことをお勧めします。

