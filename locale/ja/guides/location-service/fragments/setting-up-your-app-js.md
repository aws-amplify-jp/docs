[Amazon Location Service](https://aws.amazon.com/location/) は、アプリケーションに位置情報を追加できる新しい位置情報サービスです。 Amazon Location Service を使用すると、地図や関心のあるポイントを提供するアプリケーションを構築できます。 リソースを追跡したり、ロケーションに基づいてアクションをトリガーしたり、通りの住所を地理座標に変換したりすることもできます。

このチュートリアルでは、Amazon Location Service を使用するためのアプリの設定方法について説明します。 サービスの詳細については、 [Amazon Location Service Developer Guide](https://docs.aws.amazon.com/location/latest/developerguide/) を参照してください。

## 概要

このチュートリアルでは、次の操作を行います。

* このチュートリアルのベースとして新しい React アプリケーションを作成します。
* Amazon Location Service SDK 呼び出しには AWS SDK JavaScript v2 パッケージを使用します。
* Amplify with Authenticationの基本設定を設定します。
* React アプリケーションを Amazon Location Service に接続します。
* Amazon Location Service API を使用して場所を検索します。

### 新しい React アプリケーションの作成

まず、 [create-react-app](https://reactjs.org/docs/create-a-new-react-app.html)を使用して新しいReactアプリを作成し、開始します。 現在のベストプラクティスを使用して React アプリケーションを起動するために使用される CLI ツールです。 Amplifyを追加し、新しいプロジェクトを初期化します。次の手順でこの手順を説明します。

**新しい React アプリケーションを作成するには**

1. プロジェクトディレクトリから以下のコマンドを実行します。

```bash
npx create-react-app amazon-location-service-places
cd amazon-location-service-places
```

これにより `amazon-location-service-places` というディレクトリに新しい React アプリケーションが作成され、その新しいディレクトリに移動されます。

2. Now that you’re in the root directory of the project, run the app with the `npm start` command. This command also runs a development server so you can see the output generated by the build by navigating to `http://localhost:3000`.

これで新しいReactアプリケーションの作成と起動に成功しました。

## SDK の依存関係のインストール

クライアントで SDK を使用する最初のステップは、次のコマンドで必要な依存関係をインストールすることです。

```bash
npm install aws-sdk aws-amplify
```

## 認証を追加中

The next feature you will be adding to your React app is authentication. The Amplify Framework uses [Amazon Cognito](https://aws.amazon.com/cognito/) as the main authentication provider. Amazon Cognito is a robust user directory service that handles user registration, authentication, account recovery & other operations.

以下の手順では、Amazon Cognitoを使用してReactアプリに認証を追加し、ユーザー名/パスワードログインをサポートします。

**React アプリケーションに認証を追加するには**

1. projectsディレクトリから、次のコマンドを実行し、指定された質問に答えます。

```bash
amplify add auth

? Do you want to use the default authentication and security configuration? Default configuration
? How do you want users to be able to sign in? Username
? Do you want to configure advanced settings?  No, I am done.
```

2. `amplify push` コマンドを実行してサービスをデプロイします。

## React アプリケーションを Amazon Location Service に接続します

以下の手順では、React アプリケーションを Amazon Location Service API に接続します。

**React アプリケーションを Amazon Location Service に接続するには**

`src/App.js` ファイルを開き、次の関数を呼び出してAmazon Location Service Clientを初期化します。

```javascript
import Amplify, { Auth } from 'aws-amplify';
import Location from "aws-sdk/clients/location";
import awsconfig from './aws-exports';

Amplify.configure(awsconfig);

const createClient = async () => {
    const credentials = await Auth.currentCredentials();
    const client = new Location({
        credentials,
        region: awsconfig.aws_project_region,
   });
   return client;
}
```

これで React アプリケーションを Amazon Location Service に接続しました。

## Amazon Location Service API の使用

Amazon Location Service API にアクセスするには、リソースを作成する必要があります。 [Amazon Location Service コンソール](http://console.aws.amazon.com/location/home) を使用するか、 [AWS Command Line Interface (CLI)](https://aws.amazon.com/cli/)を使用してリソースを作成できます。 リソースを作成したら、API を呼び出すことでこれらのリソースを使用できます。

このセクションでは、Amazon Location Service API の使用例を示します。 この例では、最初に Amazon Location Service コンソールで Place Index を作成し、API を使用して場所を検索します。

### 新しい場所インデックスの作成

1. [Amazon Location Service コンソール](https://console.aws.amazon.com/location/places/home#/create) を開き、インデックスを作成します。
2. **名前** に **MyPlaceIndex** を入力します。
3. **Create place index** を押します

![アマゾンロケーションサービス - 場所のインデックスを作成](~/images/als/create-place-index.png)

4. 以下のスクリーンショットのように、 **arn:aws:geo** から始まります。

![Amazon Location Service - Place index](~/images/als/my-place-index.png)

### ゲストユーザーに場所のインデックスへのアクセスを許可する

Place Index リソースを作成したので、アプリケーションのユーザーにリソースへのアクセスを許可するインラインポリシーを作成する必要があります。

1. プロジェクトのルートに移動し、次のコマンドを実行します。
```bash
コンソールの認証を増幅する
```

1. プロンプトが表示されたら、 `Identity Pool` を選択します。
2. Amazon Cognitoコンソールに移動します。ページの右上隅にある `` IDプールを編集をクリックします。
3. `認証されていないID`のドロップダウンを開き、 `` 認証されていないIDへのアクセスを有効にするを選択し、 `` 変更を保存を押します。
4. Click on `Edit` identity pool once more. Make a note of the name of the `Unauthenticated` role. For example, `amplify-<project_name>-<env_name>-<id>-unauthRole`.
5. [AWS Identity and Access Management (IAM) コンソール](https://console.aws.amazon.com/iam/home#/roles) を開き、ロールを管理します。
6. *Search* フィールドに、上記の未認証ロールの名前を入力してクリックします。
7. *+ Add インラインポリシー*をクリックし、 *JSON* タブをクリックします。
8. *[ARN]* プレースホルダに、上記のプレースインデックスのARNを入力し、ポリシーの内容を以下に置き換えます。

```bash
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": "geo:SearchPlaceIndexForText",
            "Resource": "[ARN]"
        }
    ]
}
```

10. format@@0ボタンをクリックします。
11. `フィールドに`を入力します。
12. 「ポリシーを作成」ボタンをクリックします。Android アプリに認証が正常に追加されました。

### 場所を検索中

次のコードでは、作成したPlace Indexを使用して場所を検索するためのAmazon Location Service APIを使用する方法について詳しく説明します。

```javascript
const params = {
  IndexName: "MyPlaceIndex",
  Text: "Indianapolis",
};
client. earchPlaceIndexForText(params, (err, data) => {
  if (err) console.error(err);
  if (data) console.log(data);
});
```
